#!/bin/sh

# exit if a command fails
set -e

# Clean installation folder
rm ${CONFIG_MAGENTO_INSTALL_FOLDER}/* -rf

# Wait until the DB is ready
CONDITION="mysql -h${CONFIG_DB_HOST} -u${CONFIG_DB_USER} -p${CONFIG_DB_PASS}"
MAX_TRIES=300
SECONDS_BETWEEN_TRIES=1
c=0
while ! eval "$CONDITION"; do if [ $c -ge ${MAX_TRIES} ]; then exit 1; else c=$(($c + 1)); fi; echo "Waiting for db.. Try $c failed"; sleep ${SECONDS_BETWEEN_TRIES}; done

# Install magento if not installed
$SETUP_MAGENTO_INSTALL_SCRIPT_PATH $CONFIG_MAGENTO_INSTALL_ENV_PATH 1>/dev/stdout 2>/dev/stderr

# Setup redis config
if [ "$CONFIG_REDIS_ENABLED" = "$GENERAL_KEY_TRUE" ]; then
    [ -d "$CONFIG_PATHS_WEBROOT/app/etc/" ] || mkdir -p "$CONFIG_PATHS_WEBROOT/app/etc/";
    envsubst < $CONFIG_PATHS_TEMPLATES_REDIS > $CONFIG_PATHS_CONFIG_REDIS;
fi


exit 0