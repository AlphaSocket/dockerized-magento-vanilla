#!/bin/sh
set -e

# Install all dependencies
echo "### Install all dependencies..."
apk add --no-cache gettext $SETUP_DEPENDENCIES_SETUP $SETUP_DEPENDENCIES_CONFIG $SETUP_DEPENDENCIES_RUNTIME


# Install dependencies
echo "### Install dependencies..."
if [ ! -z "$SETUP_DEPENDENCIES_CONFIG$SETUP_DEPENDENCIES_SETUP" ]; then
    apk add --no-cache $SETUP_DEPENDENCIES_CONFIG $SETUP_DEPENDENCIES_SETUP;
fi
# Warming composer and n98 cache for config process
echo "### Warming composer and n98 cache for config process..."
if [ "$BUILD_ENV" = "cached" ]; then
    n98-magerun.phar install --only-download --magentoVersionByName=magento-mirror-${SETUP_CACHE_MAGENTO_INSTALLER_VERSION} --installationFolder=/tmp/warmCache;
    mkdir -p /tmp/warmCache;
    echo '{"require":{}}' > /tmp/warmCache/composer.json;
    composer.phar config --working-dir=/tmp/warmCache repositories.firegento composer https://packages.firegento.com;
    composer.phar config --working-dir=/tmp/warmCache extra.magento-root-dir "/tmp/warmCache";
    composer.phar require --working-dir=/tmp/warmCache magento-hackathon/magento-composer-installer;
    composer.phar require --working-dir=/tmp/warmCache firegento/debug;
    composer.phar require --working-dir=/tmp/warmCache connect20/nexcessnet_turpentine;
    rm -rf /tmp/warmCache;
    mkdir -p $( dirname ${SETUP_CACHE_MAGENTO_SAMPLE_DATA_PATH});
    curl -o $SETUP_CACHE_MAGENTO_SAMPLE_DATA_PATH $SETUP_CACHE_MAGENTO_SAMPLE_DATA_URL;
    SUM=$(md5sum $SETUP_CACHE_MAGENTO_SAMPLE_DATA_PATH | awk '{print $1;}' );
    CHECKSUM="${SETUP_CACHE_MAGENTO_SAMPLE_DATA_CHECKSUM}";
    if [ "$SUM" != "$CHECKSUM" ]; then echo "### Sample data download failed"; echo "$SUM != $CHECKSUM"; exit 1; fi;
fi



exit 0