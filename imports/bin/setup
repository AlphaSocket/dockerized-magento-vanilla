#!/bin/sh
#

# exit if a command fails
set -e

# Warming composer and n98 cache for config process
echo "### Warming composer and n98 cache for config process..."
n98-magerun.phar install --only-download --magentoVersionByName=magento-mirror-${SETUP_CACHE_MAGENTO_INSTALLER_VERSION} --installationFolder=/tmp/warmCache
composer.phar init -n --working-dir=/tmp/warmCache
composer.phar config -d=/tmp/warmCache repositories.firegento composer https://packages.firegento.com
composer.phar config -d=/tmp/warmCache extra.magento-root-dir "/tmp/warmCache"
composer.phar require -d=/tmp/warmCache magento-hackathon/magento-composer-installer
composer.phar require -d=/tmp/warmCache firegento/debug
composer.phar require -d=/tmp/warmCache connect20/nexcessnet_turpentine
rm -rf /tmp/warmCache
mkdir -p $( dirname ${SETUP_CACHE_MAGENTO_SAMPLE_DATA_PATH})
curl -o $SETUP_CACHE_MAGENTO_SAMPLE_DATA_PATH $SETUP_CACHE_MAGENTO_SAMPLE_DATA_URL
SUM=$(md5sum $SETUP_CACHE_MAGENTO_SAMPLE_DATA_PATH)
CHECKSUM="${SETUP_CACHE_MAGENTO_SAMPLE_DATA_CHECKSUM_${SETUP_CACHE_MAGENTO_SAMPLE_DATA_VERSION}_MD5}"

# Check sample data md5
echo "### Check sample data md5..."
if [ "$SUM" != "$CHECKSUM" ]; then
    echo "### Sample data download failed $SETUP_CACHE_MAGENTO_SAMPLE_DATA_URL ";
    exit 1;
fi


exit 0